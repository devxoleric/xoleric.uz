name: Fix Lock Files

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday at midnight

jobs:
  fix-lock-files:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: |
          frontend/package-lock.json
          backend/package-lock.json
    
    - name: Install dependencies
      run: |
        cd frontend && npm ci
        cd ../backend && npm ci
    
    - name: Generate lock files
      run: |
        cd frontend
        rm -rf node_modules package-lock.json
        npm install --package-lock-only
        
        cd ../backend
        rm -rf node_modules package-lock.json
        npm install --package-lock-only
    
    - name: Validate lock files
      run: |
        echo "Validating lock files..."
        
        # Check frontend lock file
        if [ -f "frontend/package-lock.json" ]; then
          if jq empty frontend/package-lock.json >/dev/null 2>&1; then
            echo "✅ frontend/package-lock.json is valid"
          else
            echo "❌ frontend/package-lock.json is invalid"
            exit 1
          fi
        fi
        
        # Check backend lock file
        if [ -f "backend/package-lock.json" ]; then
          if jq empty backend/package-lock.json >/dev/null 2>&1; then
            echo "✅ backend/package-lock.json is valid"
          else
            echo "❌ backend/package-lock.json is invalid"
            exit 1
          fi
        fi
    
    - name: Commit lock files
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Check if lock files changed
        if git diff --name-only | grep -q "package-lock.json"; then
          git add frontend/package-lock.json backend/package-lock.json
          git commit -m "chore: update lock files [skip ci]"
          git push
          echo "✅ Lock files updated and pushed"
        else
          echo "✅ No changes to lock files"
        fi
    
    - name: Create lock file report
      run: |
        cat > lock-report.md << EOF
        # Lock File Report
        
        Generated: $(date)
        
        ## Frontend
        - File: package-lock.json
        - Size: $(stat -c%s "frontend/package-lock.json") bytes
        - Dependencies: $(jq '.dependencies | length' frontend/package-lock.json)
        - Packages: $(jq '.packages | length' frontend/package-lock.json)
        
        ## Backend
        - File: package-lock.json
        - Size: $(stat -c%s "backend/package-lock.json") bytes
        - Dependencies: $(jq '.dependencies | length' backend/package-lock.json)
        - Packages: $(jq '.packages | length' backend/package-lock.json)
        
        ## Security Audit
        \`\`\`bash
        npm audit --production
        \`\`\`
        
        EOF
        
        cat lock-report.md
